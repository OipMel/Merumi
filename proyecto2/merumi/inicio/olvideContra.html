<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recuperar Contraseña</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('../imagenes/mesa3.jpg');
      background-size: cover;
      background-position: center;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .header {
      width: 100%;
      height: clamp(120px, 30vh, 320px);
      overflow: hidden;
      background-color: #011930;
      margin-bottom: 20px;
      padding: 0;
      display: block;
      position: relative;
    }

    .header img.logo-header {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center center;
      display: block;
      background-color: #011930;
    }

    .recuperar-container {
      background-color: #C0C0C0;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      width: 350px;
      text-align: center;
      position: relative;
    }

    h2 {
      margin-bottom: 10px;
    }

    p {
      color: #555;
      margin-bottom: 20px;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    button {
      width: 100%;
      background-color: rgba(11, 31, 63, 0.95);
      color: white;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background-color: rgba(9, 25, 55, 0.95);
    }

    .volver-login a {
      text-decoration: none;
      color: rgba(11, 31, 63, 0.95);
    }

    /* Mensajes */
    .mensaje-alerta {
      font-size: 14px;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      border: 1px solid;
      display: none; /* oculto por defecto */
    }

    .mensaje-exito {
      color: #006400; /* Verde oscuro */
      background-color: #e6ffe6; /* Verde claro */
      border-color: #006400;
    }

    .mensaje-error {
      color: #cc0000; /* Rojo oscuro */
      background-color: #ffe6e6; /* Rojo claro */
      border-color: #cc0000;
    }

    .mensaje-info {
      color: #004080;
      background-color: #e6f0ff;
      border-color: #004080;
    }

    .hidden {
      display: none !important;
    }

  </style>
</head>
<body>
    <header class="header">
        <img src="../imagenes/banner1.0.png" class="logo-header" />
    </header>

    <div class="recuperar-container" id="container">

        <!-- Mensaje superior -->
        <div id="message-container" class="mensaje-alerta" role="alert"></div>

        <!-- STAGE 1: Solicitud de código -->
        <div id="stage-1">
            <h2>Recuperar Contraseña</h2>
            <p>Ingresa tu correo electrónico para recibir un código de verificación.</p>
            <form id="form-request">
                <input type="email" id="email" name="email" placeholder="tuemail@ejemplo.com" required>
                <button type="submit">Enviar código</button>
            </form>
            <p class="volver-login"><a href="iniciarSesion.html">Volver al inicio de sesión</a></p>
        </div>

        <!-- STAGE 2: Ingreso de código y nueva contraseña -->
        <div id="stage-2" class="hidden">
            <h2>Nueva Contraseña</h2>
            <p>Ingresa el código que recibiste y tu nueva contraseña.</p>
            <form id="form-reset">
                <input type="text" id="code" placeholder="Código" required>
                <input type="password" id="newPassword" placeholder="Nueva contraseña (Mínimo 8 caracteres)" minlength="8" required>
                <input type="password" id="confirmNewPassword" placeholder="Repite la nueva contraseña" required>
                <button type="submit">Guardar Contraseña</button>
            </form>
            <p class="volver-login"><a href="iniciarSesion.html">Volver al inicio de sesión</a></p>
        </div>
    </div>

    <script>
        const formRequest = document.getElementById('form-request');
        const formReset = document.getElementById('form-reset');
        const stage1 = document.getElementById('stage-1');
        const stage2 = document.getElementById('stage-2');
        const messageContainer = document.getElementById('message-container');
        const emailInput = document.getElementById('email');

        let emailGlobal = '';
        let codigoRecibido = '';

        function showMessage(msg, type) {
            messageContainer.innerHTML = msg;
            messageContainer.className = `mensaje-alerta mensaje-${type}`;
            messageContainer.style.display = 'block';
        }

        function hideMessage() {
            messageContainer.style.display = 'none';
            messageContainer.textContent = '';
            messageContainer.className = 'mensaje-alerta hidden';
        }

        // Stage 1: enviar código
        if (formRequest) {
            formRequest.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage();

                const email = emailInput.value.trim();
                emailGlobal = email;

                if (!email) {
                    showMessage('Por favor, ingresa tu correo electrónico.', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('email', email);

                const submitButton = formRequest.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Enviando...';

                try {
                    const response = await fetch('../php/enviar_codigo.php', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        codigoRecibido = result.codigo; // código de la BD
                        showMessage(` Código recibido: <b>${codigoRecibido}</b>`, 'exito');

                        stage1.classList.add('hidden');
                        stage2.classList.remove('hidden');
                    } else {
                        showMessage(result.message || 'Error desconocido al solicitar el código.', 'error');
                    }
                } catch (error) {
                    console.error(error);
                    showMessage('Error de conexión con el servidor.', 'error');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar código';
                }
            });
        }

        // Stage 2: cambiar contraseña
        if (formReset) {
            formReset.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage();

                const code = document.getElementById('code').value.trim();
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;

                if (!code || !newPassword || !confirmNewPassword) {
                    showMessage('Por favor, completa todos los campos.', 'error');
                    return;
                }

                if (newPassword !== confirmNewPassword) {
                    showMessage('Las contraseñas no coinciden.', 'error');
                    return;
                }

                if (newPassword.length < 8) {
                    showMessage('La nueva contraseña debe tener al menos 8 caracteres.', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('email', emailGlobal);
                formData.append('code', code);
                formData.append('newPassword', newPassword);

                const submitButton = formReset.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Guardando...';

                try {
                    const response = await fetch('../php/cambiar_contrasena.php', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        showMessage(result.message || 'Contraseña cambiada con éxito. Redirigiendo...', 'exito');
                        setTimeout(() => {
                            window.location.href = '../inicio/iniciarSesion.html';
                        }, 2000);
                    } else {
                        showMessage(result.message || 'Error desconocido al cambiar la contraseña.', 'error');
                    }
                } catch (error) {
                    console.error(error);
                    showMessage('Error de conexión con el servidor. Intenta de nuevo.', 'error');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Guardar Contraseña';
                }
            });
        }

        // Reenviar código
        const reenviarLink = document.getElementById('reenviar-link');
        if (reenviarLink) {
            reenviarLink.addEventListener('click', (e) => {
                e.preventDefault();
                hideMessage();

                stage2.classList.add('hidden');
                stage1.classList.remove('hidden');

                document.getElementById('code').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';

                showMessage('Listo. Ahora puedes volver a presionar "Enviar código".', 'info');
            });
        }
    </script>
</body>
</html>
